<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ | SmartKey Pro</title>

<style>
    body {
        background:#000;
        color:#fff;
        font-family:Tajawal, sans-serif;
        padding:20px;
    }
    h2 {
        color:gold;
        text-align:center;
        margin-bottom:20px;
    }
    input {
        width:95%;
        padding:10px;
        margin:5px 0;
        border-radius:8px;
        border:1px solid gold;
        background:#111;
        color:#fff;
        font-size:16px;
    }
    button {
        background:gold;
        color:#000;
        padding:10px 20px;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-weight:bold;
        font-size:16px;
        margin-top:10px;
    }
    table {
        width:100%;
        margin-top:20px;
        border-collapse:collapse;
        font-size:16px;
    }
    th, td {
        border:1px solid gold;
        padding:10px;
        text-align:center;
    }
    th {
        background:#222;
        color:gold;
    }
    .delete-btn {
        background:#ff2d2d;
        color:white;
        padding:5px 10px;
        border-radius:6px;
        cursor:pointer;
        font-weight:bold;
    }
    .detail-btn {
        background:#0a84ff;
        color:white;
        padding:5px 10px;
        border-radius:6px;
        cursor:pointer;
    }
    .trans-btn {
        background:#14c400;
        color:white;
        padding:5px 10px;
        border-radius:6px;
        cursor:pointer;
    }
    #countBox {
        text-align:right;
        color:gold;
        font-size:18px;
        margin-top:10px;
    }
</style>
</head>

<body>

<h2>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>

<div style="background:#111; border:1px solid gold; padding:15px; border-radius:10px;">
    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
    <input type="text" id="customerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…">

    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</label>
    <input type="text" id="customerPhone" placeholder="05xxxxxxxx" maxlength="10">

    <button id="saveCustomer">â• Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
</div>

<h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>

<div id="countBox"></div>

<table id="customersTable">
    <thead>
        <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
            <th>ØªØ­ÙƒÙ…</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script type="module">
import { supabase } from "../supabase.js";

/* ============ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ ============ */
document.getElementById("saveCustomer").addEventListener("click", async () => {
    const name = document.getElementById("customerName").value.trim();
    const phone = document.getElementById("customerPhone").value.trim();

    // validation
    if (!name || !phone) {
        alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
        return;
    }

    if (!/^05\d{8}$/.test(phone)) {
        alert("âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…");
        return;
    }

    // check duplicate
    const { data: exist } = await supabase
        .from("customers")
        .select("id")
        .eq("phone", phone);

    if (exist && exist.length > 0) {
        alert("âš ï¸ Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„");
        return;
    }

    // insert
    const { error } = await supabase
        .from("customers")
        .insert([{ name, phone, balance: 0 }]);

    if (error) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
        console.log(error);
    } else {
        alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");

        document.getElementById("customerName").value = "";
        document.getElementById("customerPhone").value = "";

        loadCustomers();
    }
});

/* ============ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ============ */
async function loadCustomers() {
    const { data, error } = await supabase
        .from("customers")
        .select("*")
        .order("id", { ascending: false });

    const tbody = document.querySelector("#customersTable tbody");
    const countBox = document.getElementById("countBox");

    if (!data) return;

    tbody.innerHTML = "";
    countBox.innerHTML = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${data.length}`;

    data.forEach(cust => {
        tbody.innerHTML += `
            <tr>
                <td>${cust.name}</td>
                <td>${cust.phone}</td>
                <td>

                    <button class="detail-btn" onclick="openDetails(${cust.id})">ØªÙØ§ØµÙŠÙ„</button>

                    <button class="trans-btn" onclick="openTransactions(${cust.id})">Ù…Ø¹Ø§Ù…Ù„Ø§Øª</button>

                    <button class="delete-btn" onclick="deleteCustomer(${cust.id})">Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
    });
}

/* ============ Ø­Ø°Ù Ø¹Ù…ÙŠÙ„ ============ */
window.deleteCustomer = async function(id) {
    const ok = confirm("â— Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ");
    if (!ok) return;

    const { error } = await supabase
        .from("customers")
        .delete()
        .eq("id", id);

    if (error) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
    } else {
        alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
        loadCustomers();
    }
};

/* ============ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ============ */
window.openDetails = function(id) {
    localStorage.setItem("selectedCustomer", id);
    location.href = "customer_details.html";
};

/* ============ ØµÙØ­Ø© Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ============ */
window.openTransactions = function(id) {
    localStorage.setItem("selectedCustomer", id);
    location.href = "customer_transactions.html";
};

/* ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ */
loadCustomers();

</script>

</body>
</html>
