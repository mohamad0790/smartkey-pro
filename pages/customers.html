<script type="module">
import { supabase } from "../supabase.js";

// Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
document.getElementById("saveCustomer").addEventListener("click", async () => {
    const name = document.getElementById("customerName").value.trim();
    const phone = document.getElementById("customerPhone").value.trim();

    if (!name || !phone) {
        alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
        return;
    }

    // ÙÙ‚Ø· Ù†Ø±Ø³Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù„ÙŠ Ù†Ø­ØªØ§Ø¬Ù‡Ø§
    const { error } = await supabase
        .from("customers")
        .insert([{ name, phone }]);  // balance Ù„Ù‡ default Ø¨Ø§Ù„ÙØ¹Ù„

    if (error) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
        console.log("Insert Error:", error.message);
    } else {
        alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
        document.getElementById("customerName").value = "";
        document.getElementById("customerPhone").value = "";
        loadCustomers();
    }
});

// Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
async function loadCustomers() {
    const { data, error } = await supabase
        .from("customers")
        .select("id, name, phone") // ÙÙ‚Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        .order("id", { ascending: false });

    const tbody = document.querySelector("#customersTable tbody");
    tbody.innerHTML = "";

    if (error) {
        console.log("Load Error:", error.message);
        return;
    }

    data.forEach(cust => {
        tbody.innerHTML += `
            <tr>
                <td>${cust.name}</td>
                <td>${cust.phone}</td>
                <td>
                    <button class="detail-btn" onclick="openDetails('${cust.id}')">ØªÙØ§ØµÙŠÙ„</button>
                    <button class="trans-btn" onclick="openTransactions('${cust.id}')">Ù…Ø¹Ø§Ù…Ù„Ø§Øª</button>
                    <button class="delete-btn" onclick="deleteCustomer('${cust.id}')">Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
    });
}

// Ø­Ø°Ù Ø¹Ù…ÙŠÙ„
window.deleteCustomer = async function(id) {
    const ok = confirm("â— Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ");
    if (!ok) return;

    const { error } = await supabase
        .from("customers")
        .delete()
        .eq("id", id);

    if (error) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
        console.log("Delete Error:", error.message);
    } else {
        alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
        loadCustomers();
    }
};

// ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
window.openDetails = function(id) {
    localStorage.setItem("selectedCustomer", id);
    location.href = "customer_details.html";
};

// ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
window.openTransactions = function(id) {
    localStorage.setItem("selectedCustomer", id);
    location.href = "customer_transactions.html";
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
loadCustomers();
</script>
