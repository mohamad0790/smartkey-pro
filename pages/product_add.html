<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
<meta charset="UTF-8">
<title>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ | SmartKey Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        background:#000;
        color:#fff;
        font-family:Tajawal, sans-serif;
        padding:20px;
        text-align:center;
    }
    h2 {
        color:gold;
        margin-bottom:20px;
    }
    input {
        width:90%;
        padding:12px;
        margin:10px auto;
        border-radius:10px;
        border:1px solid gold;
        background:#111;
        color:#fff;
        font-size:18px;
        display:block;
    }
    button {
        background:gold;
        color:#000;
        padding:12px;
        width:90%;
        border:none;
        border-radius:10px;
        font-size:20px;
        font-weight:bold;
        margin-top:10px;
        cursor:pointer;
    }
    #preview {
        width:120px;
        margin:auto;
        margin-top:10px;
        display:none;
        border-radius:10px;
    }
    #uploadBtn {
        background:#0a84ff;
        margin-top:5px;
    }
</style>
</head>

<body>

<h2>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h2>

<input id="productCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
<input id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="buyPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
<input id="sellPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input id="quantity" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">

<!-- Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ -->
<button id="uploadBtn">ğŸ“¸ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</button>
<input type="file" id="productImage" accept="image/*" style="display:none;">
<img id="preview">

<button id="addProduct">ğŸ’¾ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù</button>

<script type="module">
import { supabase } from "../supabase.js";

/* ========== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§ ========= */
document.getElementById("uploadBtn").addEventListener("click", () => {
    document.getElementById("productImage").click();
});

document.getElementById("productImage").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById("preview").src = URL.createObjectURL(file);
    document.getElementById("preview").style.display = "block";
});

/* ========== ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ ========= */
async function generateUniqueBarcode() {
    let code;
    let exists = true;

    while (exists) {
        code = "";
        for (let i = 0; i < 8; i++) code += Math.floor(Math.random() * 10);

        const { data } = await supabase
            .from("products")
            .select("id")
            .eq("barcode", code);

        exists = data && data.length > 0;
    }

    return code;
}

/* ========== Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Storage ========= */
async function uploadImage(file) {
    if (!file) return null;

    const fileName = Date.now() + "_" + file.name;

    const { error } = await supabase.storage
        .from("products")
        .upload(fileName, file);

    if (error) {
        console.log(error);
        alert("âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
        return null;
    }

    const { data } = await supabase.storage
        .from("products")
        .getPublicUrl(fileName);

    return data.publicUrl;
}

/* ========== Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ========= */
document.getElementById("addProduct").addEventListener("click", async () => {

    let code = document.getElementById("productCode").value.trim();
    let name = document.getElementById("productName").value.trim();
    let buy = Number(document.getElementById("buyPrice").value);
    let sell = Number(document.getElementById("sellPrice").value);
    let qty = Number(document.getElementById("quantity").value);
    let file = document.getElementById("productImage").files[0];

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!name || !buy || !sell || !qty) {
        alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
        return;
    }

    if (buy <= 0 || sell <= 0 || qty <= 0) {
        alert("âš ï¸ Ø§Ù„Ù‚ÙŠÙ… ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† 0");
        return;
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡
    let barcode = code || await generateUniqueBarcode();

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    const { data: exist } = await supabase
        .from("products")
        .select("id")
        .eq("barcode", barcode);

    if (exist && exist.length > 0) {
        alert("âš ï¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹");
        return;
    }

    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
    let imageUrl = await uploadImage(file);

    // Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Supabase
    const { error } = await supabase
        .from("products")
        .insert([{
            product_code: code || null,
            name: name,
            buy: buy,
            sell: sell,
            quantity: qty,
            barcode: barcode,
            image_url: imageUrl
        }]);

    if (error) {
        console.log(error);
        alert("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù");
    } else {
        alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­");

        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById("productCode").value = "";
        document.getElementById("productName").value = "";
        document.getElementById("buyPrice").value = "";
        document.getElementById("sellPrice").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("productImage").value = "";
        document.getElementById("preview").style.display = "none";

        // ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        setTimeout(() => {
            location.href = "products.html";
        }, 400);
    }
});
</script>

</body>
</html>
