<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">

<style>
    body {
        background: #000;
        color: #fff;
        font-family: Tajawal, sans-serif;
        padding: 15px;
    }
    h2 {
        text-align: center;
        color: gold;
    }
    .box {
        background: #111;
        border: 2px solid gold;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    input, select, textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid gold;
        background: #222;
        color: gold;
        margin-bottom: 10px;
        font-size: 16px;
    }
    button {
        background: gold;
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 10px;
    }
    .record {
        background: #111;
        border: 1px solid gold;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
    }
    .buttons {
        display: flex;
        gap: 10px;
    }
    .edit-btn {
        flex: 1;
        background: #0a84ff;
        color: #fff;
        border: none;
        padding: 10px;
        border-radius: 6px;
    }
    .del-btn {
        flex: 1;
        background: #ff3b30;
        color: #fff;
        border: none;
        padding: 10px;
        border-radius: 6px;
    }
</style>
</head>

<body>

<h2>ğŸ“Œ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>

<div class="box">
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
    <select id="type">
        <option value="Ø¯ÙŠÙ†">Ø¯ÙŠÙ†</option>
        <option value="Ø¯ÙØ¹">Ø¯ÙØ¹</option>
    </select>

    <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
    <input type="number" id="amount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">

    <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
    <textarea id="note" rows="2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>

    <button onclick="saveTransaction()">âœ” Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
</div>

<div class="box">
    <h3 style="color: gold;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
    <div id="summary"></div>
</div>

<div class="box">
    <h3 style="color: gold;">ğŸ“œ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
    <div id="records"></div>
</div>

<script type="module">
import { supabase } from "../supabase.js";

/* ============= Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© ============= */
window.saveTransaction = async function () {
    const customerId = localStorage.getItem("selectedCustomer");
    const type = document.getElementById("type").value;
    const amount = Number(document.getElementById("amount").value);
    const note = document.getElementById("note").value;

    if (!amount || amount <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

    // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø±ØµÙŠØ¯
    const { data: last } = await supabase
        .from("customer_transactions")
        .select("balance_after")
        .eq("customer_id", customerId)
        .order("created_at", { ascending: false })
        .limit(1);

    let previous = last?.length ? last[0].balance_after : 0;
    let newBalance = type === "Ø¯ÙŠÙ†" ? previous + amount : previous - amount;

    if (newBalance < 0) return alert("Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØµØ¨Ø­ Ø³Ø§Ù„Ø¨!");

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    await supabase
        .from("customer_transactions")
        .insert([{
            customer_id: customerId,
            type,
            amount,
            note,
            balance_after: newBalance,
            created_at: new Date().toISOString()
        }]);

    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
    await supabase
        .from("customers")
        .update({ balance: newBalance })
        .eq("id", customerId);

    loadData();
};

/* ============= ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ============= */
async function loadData() {
    const customerId = localStorage.getItem("selectedCustomer");

    const { data: records } = await supabase
        .from("customer_transactions")
        .select("*")
        .eq("customer_id", customerId)
        .order("created_at", { ascending: false });

    let totalDebt = 0;
    let totalPay = 0;

    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    let html = "";
    records.forEach(r => {
        if (r.type === "Ø¯ÙŠÙ†") totalDebt += r.amount;
        else totalPay += r.amount;

        html += `
        <div class="record">
            <div><b>Ø§Ù„Ù†ÙˆØ¹:</b> ${r.type}</div>
            <div><b>Ø§Ù„Ù…Ø¨Ù„Øº:</b> ${r.amount}</div>
            <div><b>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</b> ${r.balance_after}</div>
            <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${r.created_at.split("T")[0]}</div>
            <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ${r.note || "â€”"}</div>

            <div class="buttons">
                <button class="edit-btn" onclick="editRecord('${r.id}', '${r.type}', ${r.amount}, '${r.note}')">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="del-btn" onclick="deleteRecord('${r.id}')">Ø­Ø°Ù</button>
            </div>
        </div>`;
    });

    document.getElementById("records").innerHTML = html;

    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ø®Øµ
    document.getElementById("summary").innerHTML = `
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†:</b> ${totalDebt}</div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª:</b> ${totalPay}</div>
        <div><b>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${(totalDebt - totalPay)}</div>
    `;
}

/* ============= ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ============= */
window.editRecord = async function (id, type, amount, note) {
    let newAmount = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯:", amount);
    if (!newAmount || newAmount <= 0) return;

    let newNote = prompt("Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©:", note);

    await supabase
        .from("customer_transactions")
        .update({ amount: Number(newAmount), note: newNote })
        .eq("id", id);

    loadData();
};

/* ============= Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© ============= */
window.deleteRecord = async function (id) {
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;

    await supabase
        .from("customer_transactions")
        .delete()
        .eq("id", id);

    loadData();
};

loadData();
</script>

</body>
</html>
