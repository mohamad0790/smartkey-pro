<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³Ø¯Ø§Ø¯ ÙØ§ØªÙˆØ±Ø© | SmartKey Pro</title>

<style>
    body { direction: rtl; padding: 15px; font-family: sans-serif; }
    label { margin-top: 10px; display: block; font-weight: bold; }
    input, select {
        width: 100%; padding: 10px; border-radius: 6px;
        border: 1px solid #ccc; margin-top: 5px;
    }
    button {
        padding: 12px; width: 100%;
        background:#000; color:#fff; border:none;
        margin-top: 20px; border-radius: 6px;
        font-size: 18px;
    }
</style>

<script type="module">
import { supabase } from "../js/supabase.js";

const loadInvoices = async () => {
    const { data } = await supabase
        .from("sales_invoices")
        .select("*")
        .gte("remaining_amount", 1);

    let sel = document.getElementById("invoice");
    sel.innerHTML = "<option value=''>Ø§Ø®ØªØ± ÙØ§ØªÙˆØ±Ø©</option>";

    data.forEach(inv => {
        sel.innerHTML += `
            <option value="${inv.id}">
                ÙØ§ØªÙˆØ±Ø© #${inv.id.slice(0,6)} â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${inv.remaining_amount}
            </option>`;
    });
};

const savePayment = async () => {
    let invoice = document.getElementById("invoice").value;
    let amount = document.getElementById("amount").value;

    if (!invoice || !amount) return alert("Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„");

    await supabase.from("sales_payments").insert({
        invoice_id: invoice,
        amount: amount
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    await supabase.rpc("update_remaining_after_payment", {
        invoice_id_input: invoice,
        paid_input: amount
    });

    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© âœ”");
    location.reload();
};

window.onload = loadInvoices;
</script>

</head>
<body>

<h2>ğŸ’µ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„</h2>

<label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
<select id="invoice"></select>

<label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
<input id="amount" type="number" placeholder="Ù…Ø«Ø§Ù„: 50">

<button onclick="savePayment()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>

</body>
</html>
