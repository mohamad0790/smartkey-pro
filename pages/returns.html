<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª | SmartKey Pro</title>
<style>
    body { font-family: 'Tahoma'; background:#f7f7f7; margin:0; padding:20px; }
    .box { background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px #ddd; max-width:600px; margin:auto; }
    input, select { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:6px; }
    button { width:100%; padding:12px; background:#1a73e8; color:#fff; border:0; border-radius:8px; font-size:18px; cursor:pointer; }
    button:hover { background:#135ccf; }
</style>
</head>

<body>
<div class="box">

<h2>ğŸ”„ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>

<label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
<input id="invoiceId" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">

<button onclick="loadInvoice()">Ø¬Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>

<div id="itemsBox"></div>

</div>

<script type="module">
import { supabase } from "../js/supabase.js";

async function loadInvoice() {
    const id = document.getElementById("invoiceId").value.trim();
    if (!id) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©");

    const { data, error } = await supabase
        .from("invoice_items")
        .select("*")
        .eq("invoice_id", id);

    if (error) return alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
    if (!data.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");

    let html = `<h3>Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù:</h3><select id="itemSelect">`;

    data.forEach(item => {
        html += `<option value="${item.id}" data-product="${item.product_id}" data-qty="${item.quantity}">
                  ${item.product_name} â€” ${item.quantity}
                 </option>`;
    });

    html += `</select>
        <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©:</label>
        <input id="returnQty" type="number" min="1">

        <label>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:</label>
        <input id="reason" type="text" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹">

        <button onclick="saveReturn()">Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>`;

    document.getElementById("itemsBox").innerHTML = html;
}

async function saveReturn() {
    const itemSelect = document.getElementById("itemSelect");
    const returnQty = document.getElementById("returnQty").value;
    const reason = document.getElementById("reason").value;
    const invoiceId = document.getElementById("invoiceId").value;

    const productId = itemSelect.selectedOptions[0].dataset.product;

    if (!returnQty) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©");

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹
    await supabase.from("returns").insert({
        invoice_id: invoiceId,
        product_id: productId,
        quantity: returnQty,
        reason: reason
    });

    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    await supabase.rpc("increase_stock", {
        product_id_input: productId,
        qty_input: returnQty
    });

    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
    location.reload();
}
</script>

</body>
</html>
