<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        background: #fff;
        color: #000;
        font-family: Arial;
        margin: 20px;
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
    }

    #productList {
        margin-bottom: 20px;
    }

    .barcode-card {
        width: 38mm;
        height: 25mm;
        border: 1px dashed #999;
        padding: 4px;
        text-align: center;
        font-size: 12px;
        display: inline-block;
        margin: 3px;
    }

    .barcode-card img {
        width: 100%;
        height: 18mm;
    }

    @media print {
        #controls {
            display: none;
        }
        body {
            margin: 0;
        }
    }
</style>

<!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<script type="module">
import { supabase } from "../supabase.js";

const productList = document.getElementById("productList");
const barcodesContainer = document.getElementById("barcodesContainer");

/* ============= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ============= */
async function loadProducts() {
    const { data } = await supabase
        .from("products")
        .select("id, name, product_code")
        .order("name");

    productList.innerHTML = "";

    data?.forEach(p => {
        productList.innerHTML += `
            <option value="${p.id}">
                ${p.name} â€” (${p.product_code})
            </option>
        `;
    });
}

loadProducts();

/* ============= ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ============= */
window.generateBarcodes = async function () {
    const selected = [...productList.selectedOptions].map(o => o.value);

    if (selected.length === 0) {
        alert("Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
        return;
    }

    barcodesContainer.innerHTML = "";

    for (let id of selected) {
        const { data: product } = await supabase
            .from("products")
            .select("name, product_code")
            .eq("id", id)
            .single();

        for (let i = 0; i < 1; i++) {
            const div = document.createElement("div");
            div.className = "barcode-card";

            const canvas = document.createElement("canvas");
            JsBarcode(canvas, product.product_code, {
                format: "CODE128",
                displayValue: true,
                fontSize: 12,
                margin: 0
            });

            div.innerHTML = `
                <strong>${product.name}</strong><br>
            `;
            div.appendChild(canvas);
            barcodesContainer.appendChild(div);
        }
    }
};

/* ============= Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© ============= */
window.printPage = function () {
    window.print();
};
</script>

</head>

<body>

<h2>ğŸ“¦ Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

<div id="controls">

    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØªØ¬):</label>
    <select id="productList" multiple size="10" style="width:100%; padding:10px;">

    </select>

    <button onclick="generateBarcodes()" style="width:100%; padding:12px; margin-top:10px; background:black; color:white; font-size:18px; border-radius:10px;">
        ğŸ¯ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    </button>

    <button onclick="printPage()" style="width:100%; padding:12px; margin-top:10px; background:gold; color:black; font-size:18px; border-radius:10px;">
        ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
    </button>
</div>

<hr>

<div id="barcodesContainer"></div>

</body>
</html>
