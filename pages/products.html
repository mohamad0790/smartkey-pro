<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
<meta charset="UTF-8">
<title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª | SmartKey Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        background:#000;
        color:#fff;
        font-family:Tajawal, Arial;
        padding:20px;
        text-align:center;
    }
    h2 {
        color:gold;
        margin-bottom:15px;
    }
    button {
        background:gold;
        color:#000;
        padding:10px 15px;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-size:16px;
        font-weight:bold;
        margin:5px;
    }
    .editBtn {
        background:#ff9500;
        color:#fff;
        padding:6px 10px;
        border-radius:8px;
    }
    table {
        width:100%;
        margin-top:20px;
        border-collapse:collapse;
    }
    th, td {
        border:1px solid gold;
        padding:10px;
    }
    th {
        background:#222;
        color:gold;
    }
    .barcode-button {
        background:#0a84ff;
        color:#fff;
        padding:6px 10px;
        border-radius:8px;
        margin-top:4px;
    }

    /* Ù†Ù…ÙˆØ°Ø¬ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ */
    #printArea {
        display:none;
    }

    .barcode-card {
        width: 30mm;
        height: 18mm;
        border: 1px solid #000;
        padding: 2px;
        text-align:center;
        font-size:9px;
        box-sizing:border-box;
        margin:1px auto;
    }

    .barcode-card canvas {
        width:100%;
        height:10mm;
    }

    #loading {
        display:none;
        font-size:20px;
        color:gold;
        margin-top:20px;
    }

    @media print {
        body { background:#fff; color:#000; }
        #controls, table { display:none; }
        #printArea { display:block; }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

</head>

<body>

<h2>ğŸ“¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

<div id="controls">
    <button onclick="window.location.href='product_add.html'">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    <button onclick="printAllBarcodes()" style="background:#0a84ff;color:white;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
</div>

<div id="loading">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<table>
<thead>
<tr>
    <th>Ø§Ù„ØµÙˆØ±Ø©</th>
    <th>Ø§Ù„ÙƒÙˆØ¯</th>
    <th>Ø§Ù„Ø§Ø³Ù…</th>
    <th>Ø´Ø±Ø§Ø¡</th>
    <th>Ø¨ÙŠØ¹</th>
    <th>ÙƒÙ…ÙŠØ©</th>
    <th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
    <th>ØªØ­ÙƒÙ…</th>
</tr>
</thead>
<tbody id="productsTable"></tbody>
</table>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div id="printArea"></div>


<script type="module">
import { supabase } from "../supabase.js";

let allProducts = [];

/* ============ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ============ */
async function loadProducts() {

    document.getElementById("loading").style.display = "block";

    const { data, error } = await supabase
        .from("products")
        .select("*")
        .order("id", { ascending:false });

    if (error) {
        alert("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");
        return;
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯Ù‡
    for (let p of data) {
        if (!p.barcode) {
            let newCode = await generateUniqueBarcode();
            await supabase
                .from("products")
                .update({ barcode: newCode })
                .eq("id", p.id);
            p.barcode = newCode;
        }
    }

    allProducts = data;

    displayProducts();

    document.getElementById("loading").style.display = "none";
}

/* ============ ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ ============ */
async function generateUniqueBarcode() {
    let code;
    let exists = true;

    while (exists) {
        code = "";
        for (let i = 0; i < 8; i++) {
            code += Math.floor(Math.random() * 10);
        }

        const { data } = await supabase
            .from("products")
            .select("id")
            .eq("barcode", code);

        exists = data && data.length > 0;
    }

    return code;
}

/* ============ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ============ */
function displayProducts() {
    const table = document.getElementById("productsTable");
    table.innerHTML = "";

    allProducts.forEach(p => {
        table.innerHTML += `
        <tr>
            <td>${p.image_url ? `<img src="${p.image_url}" width="50">` : "â€”"}</td>
            <td>${p.product_code || "â€”"}</td>
            <td>${p.name}</td>
            <td>${p.buy}</td>
            <td>${p.sell}</td>
            <td>${p.quantity}</td>
            <td>${p.barcode}</td>

            <td>
                <button class="barcode-button" onclick="printSingle('${p.name}','${p.barcode}')">ğŸ–¨ï¸</button>
                <button class="editBtn" onclick="editProduct(${p.id})">âœï¸</button>
            </td>
        </tr>`;
    });
}

/* ============ ØªØ­Ø±ÙŠØ± Ù…Ù†ØªØ¬ ============ */
window.editProduct = function(id) {
    localStorage.setItem("editProduct", id);
    location.href = "product_edit.html";
};

/* ============ Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ ============ */
window.printSingle = function(name, barcode) {
    const area = document.getElementById("printArea");
    area.innerHTML = "";

    area.innerHTML = `
        <div class="barcode-card">
            <div>${name}</div>
            <canvas id="oneBarcode"></canvas>
            <div>${barcode}</div>
        </div>
    `;

    JsBarcode("#oneBarcode", barcode, { format: "CODE128", displayValue: false, margin:0 });

    window.print();
};

/* ============ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª ============ */
window.printAllBarcodes = function () {
    const area = document.getElementById("printArea");
    area.innerHTML = "";

    if (allProducts.length === 0) {
        alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");
        return;
    }

    allProducts.forEach(p => {
        area.innerHTML += `
            <div class="barcode-card">
                <div>${p.name}</div>
                <canvas id="b${p.id}"></canvas>
                <div>${p.barcode}</div>
            </div>
        `;
    });

    setTimeout(() => {
        allProducts.forEach(p => {
            JsBarcode(`#b${p.id}`, p.barcode, { format: "CODE128", displayValue: false, margin:0 });
        });

        window.print();
        alert("âœ”ï¸ ØªÙ… ØªØ¬Ù‡ÙŠØ² ÙƒØ§ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");

    }, 200);
};

loadProducts();
</script>

</body>
</html>
