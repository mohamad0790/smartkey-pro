<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        background:#000;
        color:#fff;
        font-family:Tajawal, Arial;
        padding:20px;
        text-align:center;
    }
    h2 {
        color:gold;
        margin-bottom:15px;
    }
    button {
        background:gold;
        color:#000;
        padding:10px 15px;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-size:16px;
        font-weight:bold;
        margin:5px;
    }
    table {
        width:100%;
        margin-top:20px;
        border-collapse:collapse;
    }
    th, td {
        border:1px solid gold;
        padding:10px;
    }
    th {
        background:#222;
        color:gold;
    }
    .barcode-button {
        background:#0a84ff;
        color:#fff;
        padding:6px 10px;
        border-radius:8px;
        margin-top:4px;
    }

    /* Ù†Ù…ÙˆØ°Ø¬ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ */
    #printArea {
        display:none;
    }

    .barcode-card {
        width: 30mm;
        height: 20mm;
        border: 1px solid #000;
        padding: 2px;
        text-align:center;
        font-size:10px;
        box-sizing:border-box;
        margin:2px auto;
    }

    .barcode-card canvas {
        width:100%;
        height:12mm;
    }

    @media print {
        body { background:#fff; color:#000; }
        #controls, table { display:none; }
        #printArea { display:block; }
    }
</style>

<!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

</head>

<body>

<h2>ğŸ“¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

<div id="controls">
    <button onclick="window.location.href='product_add.html'">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    <button onclick="printAllBarcodes()" style="background:#0a84ff;color:white;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
</div>

<table>
<thead>
<tr>
    <th>Ø§Ù„ØµÙˆØ±Ø©</th>
    <th>Ø§Ù„ÙƒÙˆØ¯</th>
    <th>Ø§Ù„Ø§Ø³Ù…</th>
    <th>Ø´Ø±Ø§Ø¡</th>
    <th>Ø¨ÙŠØ¹</th>
    <th>ÙƒÙ…ÙŠØ©</th>
    <th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
    <th>Ø·Ø¨Ø§Ø¹Ø©</th>
</tr>
</thead>
<tbody id="productsTable"></tbody>
</table>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div id="printArea"></div>

<script type="module">
import { supabase } from "../supabase.js";

let allProducts = [];

/* ============ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ============ */
async function loadProducts() {
    const { data, error } = await supabase
        .from("products")
        .select("*");

    if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");
        return;
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù… ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯
    for (let p of data) {
        if (!p.barcode) {
            let newCode = generateBarcode();
            await supabase
                .from("products")
                .update({ barcode: newCode })
                .eq("id", p.id);
            p.barcode = newCode;
        }
    }

    allProducts = data;
    displayProducts();
}

/* ============ ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ 8 Ø£Ø±Ù‚Ø§Ù… ============ */
function generateBarcode() {
    let code = "";
    for (let i = 0; i < 8; i++) {
        code += Math.floor(Math.random() * 10);
    }
    return code;
}

/* ============ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ============ */
function displayProducts() {
    const table = document.getElementById("productsTable");
    table.innerHTML = "";

    allProducts.forEach(p => {
        table.innerHTML += `
        <tr>
            <td>${p.image_url ? `<img src="${p.image_url}" width="50">` : "â€”"}</td>
            <td>${p.product_code}</td>
            <td>${p.name}</td>
            <td>${p.buy}</td>
            <td>${p.sell}</td>
            <td>${p.quantity}</td>
            <td>${p.barcode}</td>
            <td>
                <button class="barcode-button" onclick="printSingle('${p.name}','${p.barcode}')">
                    ğŸ–¨ï¸
                </button>
            </td>
        </tr>`;
    });
}

/* ============ Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ ============ */
window.printSingle = function(name, barcode) {
    const area = document.getElementById("printArea");
    area.innerHTML = "";

    area.innerHTML = `
        <div class="barcode-card">
            <div>${name}</div>
            <canvas id="oneBarcode"></canvas>
            <div>${barcode}</div>
        </div>
    `;

    JsBarcode("#oneBarcode", barcode, { format: "CODE128", displayValue: false });

    window.print();
};

/* ============ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª ============ */
window.printAllBarcodes = function () {
    const area = document.getElementById("printArea");
    area.innerHTML = "";

    allProducts.forEach(p => {
        area.innerHTML += `
            <div class="barcode-card">
                <div>${p.name}</div>
                <canvas id="b${p.id}"></canvas>
                <div>${p.barcode}</div>
            </div>
        `;

        setTimeout(() => {
            JsBarcode(`#b${p.id}`, p.barcode, { format: "CODE128", displayValue: false });
        }, 50);
    });

    window.print();
};

loadProducts();
</script>

</body>
</html>
