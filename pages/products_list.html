<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>

<style>
body {
    background:#000;
    color:#fff;
    font-family:Tajawal, Arial;
    text-align:center;
    padding:20px;
}

h2 {
    color:gold;
    margin-bottom:15px;
}

button {
    background:gold;
    color:#000;
    padding:8px 15px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
    font-weight:bold;
}

input[type="search"] {
    width:90%;
    padding:10px;
    margin-top:15px;
    border-radius:8px;
    border:1px solid gold;
    background:#222;
    color:#fff;
    font-size:16px;
}

table {
    width:100%;
    margin-top:20px;
    border-collapse:collapse;
}

th, td {
    border:1px solid gold;
    padding:10px;
}

th {
    background:#222;
    color:gold;
}

.action-btn {
    background:#444;
    color:#fff;
    padding:5px 10px;
    border-radius:6px;
    margin:2px;
}

#popup, #editPopup {
    display:none;
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.8);
    justify-content:center;
    align-items:center;
}

.popup-box {
    background:#111;
    padding:20px;
    border:2px solid gold;
    border-radius:12px;
    width:90%;
    max-width:400px;
}

input {
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid gold;
    background:#222;
    color:#fff;
}

img.product-image {
    width:70px;
    height:70px;
    border-radius:6px;
    object-fit:cover;
    border:2px solid #555;
}
</style>
</head>

<body>

<h2>ğŸ“¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

<button onclick="openPopup()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ù‡Ù†Ø§</button>
<button onclick="goToAddPage()" style="background:#444;color:#fff;">ğŸ”— ØµÙØ­Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©</button>

<input id="searchBox" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬â€¦" oninput="searchProducts()">

<table>
<thead>
<tr>
<th>Ø§Ù„ØµÙˆØ±Ø©</th>
<th>Ø§Ù„ÙƒÙˆØ¯</th>
<th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th> <!-- âœ¨ ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø´Ø±Ø§Ø¡</th>
<th>Ø¨ÙŠØ¹</th>
<th>ÙƒÙ…ÙŠØ©</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="productsTable"></tbody>
</table>

<!-- Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù -->
<div id="popup">
    <div class="popup-box">
        <h3 style="color:gold;">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>

        <input id="addCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
        <input id="addName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
        <input id="addBuy" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
        <input id="addSell" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
        <input id="addQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">

        <label style="color:gold;">ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input id="addImage" type="file" accept="image/*" capture="environment">

        <button onclick="saveProduct()">Ø­ÙØ¸</button>
        <button onclick="closePopup()" style="background:#444;color:#fff;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù -->
<div id="editPopup">
    <div class="popup-box">
        <h3 style="color:gold;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3>

        <input id="editCode">
        <input id="editBarcode" disabled> <!-- âœ¨ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
        <input id="editName">
        <input id="editBuy" type="number">
        <input id="editSell" type="number">
        <input id="editQty" type="number">

        <label style="color:gold;">ğŸ“¸ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="editImage" type="file" accept="image/*" capture="environment">

        <button onclick="updateProduct()">ØªØ­Ø¯ÙŠØ«</button>
        <button onclick="closeEditPopup()" style="background:#444;color:#fff;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script type="module">
import { supabase } from "../supabase.js";

let allProducts = [];
let editId = null;
let oldImageUrl = null;

window.goToAddPage = function () {
    window.location.href = "add_product.html";
};

window.openPopup = () => document.getElementById("popup").style.display = "flex";
window.closePopup = () => document.getElementById("popup").style.display = "none";
window.closeEditPopup = () => document.getElementById("editPopup").style.display = "none";

async function uploadImage(file) {
    if (!file) return null;

    const fileName = `product_${Date.now()}.jpg`;

    const { error } = await supabase.storage
        .from("images")
        .upload(fileName, file);

    if (error) {
        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
        return null;
    }

    return supabase.storage.from("images").getPublicUrl(fileName).data.publicUrl;
}

/* -------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -------- */
async function loadProducts() {
    const { data, error } = await supabase
        .from("products")
        .select("*")
        .order("id", { ascending:false });

    if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");
        return;
    }

    allProducts = data;
    displayProducts(allProducts);
}

/* -------- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -------- */
function displayProducts(list) {
    const table = document.getElementById("productsTable");
    table.innerHTML = "";

    list.forEach(p => {
        table.innerHTML += `
        <tr>
            <td>${p.image_url ? `<img src="${p.image_url}" class="product-image">` : "â€”"}</td>
            <td>${p.product_code}</td>
            <td>${p.barcode ?? "â€”"}</td> <!-- âœ¨ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
            <td>${p.name}</td>
            <td>${p.buy}</td>
            <td>${p.sell}</td>
            <td>${p.quantity}</td>
            <td>
                <button class="action-btn" onclick="editProduct(${p.id})">âœ ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="action-btn" onclick="deleteProduct(${p.id})" style="background:red;">ğŸ—‘ Ø­Ø°Ù</button>
            </td>
        </tr>`;
    });
}

/* -------- Ø§Ù„Ø¨Ø­Ø« -------- */
window.searchProducts = function () {
    const text = document.getElementById("searchBox").value.trim();

    const filtered = allProducts.filter(p =>
        (p.name + "").includes(text) ||
        (p.product_code + "").includes(text) ||
        (p.barcode + "").includes(text)   // âœ¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    );

    displayProducts(filtered);
};

/* -------- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ -------- */
window.saveProduct = async function () {
    const barcode = Date.now().toString(); // âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ

    const pCode = document.getElementById("addCode").value;
    const pName = document.getElementById("addName").value;
    const pBuy  = document.getElementById("addBuy").value;
    const pSell = document.getElementById("addSell").value;
    const pQty  = document.getElementById("addQty").value;

    const imageFile = document.getElementById("addImage").files[0];
    const imageUrl = await uploadImage(imageFile);

    await supabase.from("products").insert({
        product_code: pCode,
        name: pName,
        buy: pBuy,
        sell: pSell,
        quantity: pQty,
        image_url: imageUrl,
        barcode: barcode  // âœ¨ Ø§Ù„Ø­ÙØ¸
    });

    closePopup();
    loadProducts();
};

/* -------- ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -------- */
window.editProduct = function (id) {
    const p = allProducts.find(x => x.id === id);
    if (!p) return;

    editId = id;
    oldImageUrl = p.image_url;

    document.getElementById("editCode").value = p.product_code;
    document.getElementById("editBarcode").value = p.barcode; // âœ¨ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    document.getElementById("editName").value = p.name;
    document.getElementById("editBuy").value = p.buy;
    document.getElementById("editSell").value = p.sell;
    document.getElementById("editQty").value = p.quantity;

    document.getElementById("editPopup").style.display = "flex";
};

/* -------- ØªØ­Ø¯ÙŠØ« -------- */
window.updateProduct = async function () {
    const newImageFile = document.getElementById("editImage").files[0];

    let finalImageUrl = oldImageUrl;

    if (newImageFile) {
        finalImageUrl = await uploadImage(newImageFile);
    }

    await supabase.from("products")
        .update({
            product_code: document.getElementById("editCode").value,
            name: document.getElementById("editName").value,
            buy: document.getElementById("editBuy").value,
            sell: document.getElementById("editSell").value,
            quantity: document.getElementById("editQty").value,
            image_url: finalImageUrl
        })
        .eq("id", editId);

    closeEditPopup();
    loadProducts();
};

/* -------- Ø­Ø°Ù -------- */
window.deleteProduct = async function (id) {
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;

    await supabase.from("products").delete().eq("id", id);
    loadProducts();
};

loadProducts();
</script>

</body>
</html>
