<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</title>

<style>
    body { font-family: "Tajawal", Arial; background:#f5f5f5; margin:0; padding:15px; text-align:center; }
    h2 { color:#333; margin-bottom:15px; }
    .box { background:#fff; padding:15px; border-radius:12px; box-shadow:0 0 10px #ccc; margin:auto; max-width:600px; }
    select, input { width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; padding:12px; border:none; color:#fff; font-size:17px; border-radius:8px; margin-top:10px; cursor:pointer; }
    #scanBtn { background:#28a745; font-size:18px !important; }
    #cameraPreview { width:100%; display:none; border-radius:10px; margin-bottom:10px; }
    table { width:100%; margin-top:10px; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    .totalBox { background:#d9ffd9; padding:12px; margin-top:15px; border-radius:8px; font-size:18px; font-weight:bold; }
    .delete-btn { background:red; color:white; padding:6px 10px; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>

<body>

<h2>ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>

<button id="scanBtn">ğŸ” Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
<video id="cameraPreview"></video>

<div class="box">

    <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
    <select id="customerSelect"></select>

    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬:</label>
    <select id="productSelect"></select>

    <input type="text" id="barcodeInput" placeholder="ğŸ“· Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <input type="number" id="qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1">

    <button id="addBtn">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØµÙ†Ù</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th>Ø­Ø°Ù</th>
            </tr>
        </thead>
        <tbody id="itemsTable"></tbody>
    </table>

    <div class="totalBox">
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span id="totalFinal">0</span> Ø±ÙŠØ§Ù„
    </div>

    <button id="saveInvoice">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>

</div>

<script type="module">
/*** Ø±Ø¨Ø· Supabase ***/
import { supabase } from "../supabase.js?v=1";

let products = [];
let customers = [];
let invoiceItems = [];

/*** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ***/
async function loadCustomers() {
    const { data } = await supabase.from("customers").select("*");
    customers = data || [];
    
    let select = document.getElementById("customerSelect");
    select.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>";

    customers.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
}

/*** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ***/
async function loadProducts() {
    const { data } = await supabase.from("products").select("*");
    products = data || [];

    let select = document.getElementById("productSelect");
    select.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>";

    products.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
}

/*** Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ***/
let scannerActive = false;
let video = document.getElementById("cameraPreview");

async function startScanner() {
    let stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });

    video.srcObject = stream;
    video.style.display = "block";
    video.play();
    scannerActive = true;
    scanLoop();
}

async function scanLoop() {
    if (!scannerActive) return;

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    try {
        const barcodeDetector = new BarcodeDetector({ formats: ['code_128', 'ean_13'] });
        const barcodes = await barcodeDetector.detect(canvas);

        if (barcodes.length > 0) {
            let code = barcodes[0].rawValue;
            addBarcodeProduct(code);
            stopScanner();
        }

    } catch (e) {}

    requestAnimationFrame(scanLoop);
}

function stopScanner() {
    scannerActive = false;
    video.style.display = "none";
    let stream = video.srcObject;
    let tracks = stream.getTracks();
    tracks.forEach(track => track.stop());
}

/*** Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø© ***/
function addItem() {
    let productId = document.getElementById("productSelect").value;
    let qty = parseInt(document.getElementById("qty").value);

    if (!productId || qty <= 0) return;

    let p = products.find(x => x.id == productId);

    invoiceItems.push({
        id: p.id,
        name: p.name,
        price: p.price,
        qty
    });

    renderItems();
}

function addBarcodeProduct(barcode) {
    let p = products.find(x => x.barcode == barcode);
    if (!p) return alert("âš ï¸ Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

    invoiceItems.push({
        id: p.id,
        name: p.name,
        price: p.price,
        qty: 1
    });

    renderItems();
}

/*** Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù ***/
function renderItems() {
    let table = document.getElementById("itemsTable");
    table.innerHTML = "";

    let total = 0;

    invoiceItems.forEach((i, idx) => {
        let rowTotal = i.price * i.qty;
        total += rowTotal;

        table.innerHTML += `
            <tr>
                <td>${i.name}</td>
                <td>${i.qty}</td>
                <td>${i.price}</td>
                <td>${rowTotal}</td>
                <td><button class="delete-btn" onclick="deleteItem(${idx})">ğŸ—‘ï¸</button></td>
            </tr>
        `;
    });

    document.getElementById("totalFinal").innerText = total;
}

window.deleteItem = function(idx) {
    invoiceItems.splice(idx, 1);
    renderItems();
}

/*** Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ***/
async function saveInvoice() {
    if (invoiceItems.length === 0) return alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù");

    let customerId = document.getElementById("customerSelect").value;
    if (!customerId) return alert("âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");

    let total = invoiceItems.reduce((s, i) => s + (i.price * i.qty), 0);

    const { data, error } = await supabase
        .from("invoices")
        .insert([{ customer_id: customerId, total }])
        .select();

    if (error) return alert("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");

    let invoiceId = data[0].id;

    for (let item of invoiceItems) {
        await supabase.from("invoice_items").insert([{
            invoice_id: invoiceId,
            product_id: item.id,
            qty: item.qty,
            price: item.price
        }]);
    }

    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
    invoiceItems = [];
    renderItems();
}

/*** EVENTS ***/
document.getElementById("scanBtn").onclick = startScanner;
document.getElementById("addBtn").onclick = addItem;
document.getElementById("saveInvoice").onclick = saveInvoice;

/*** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ ***/
loadCustomers();
loadProducts();

</script>

</body>
</html>
