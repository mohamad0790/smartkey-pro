import { supabase } from "../supabase.js";

let products = [];
let customers = [];
let invoiceItems = [];

// تحميل العملاء
async function loadCustomers() {
    const { data, error } = await supabase.from("customers").select("*");
    let select = document.getElementById("customerSelect");

    select.innerHTML = "<option value=''>اختر العميل</option>";

    if (data) {
        customers = data;
        data.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    }
}

// تحميل المنتجات
async function loadProducts() {
    const { data, error } = await supabase.from("products").select("*");
    let select = document.getElementById("productSelect");

    select.innerHTML = "<option value=''>اختر المنتج</option>";

    if (data) {
        products = data;
        data.forEach(p => {
            select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
    }
}

// إضافة صنف للفاتورة
window.addItem = function () {
    let productId = document.getElementById("productSelect").value;
    let qty = parseFloat(document.getElementById("qty").value);
    let discount = parseFloat(document.getElementById("discount").value) || 0;

    if (!productId || qty <= 0) return alert("الرجاء اختيار المنتج وإدخال كمية");

    let product = products.find(p => p.id == productId);

    let price = parseFloat(product.sell);
    let total = (price * qty) - discount;

    invoiceItems.push({
        name: product.name,
        qty,
        price,
        discount,
        total
    });

    renderItems();
};

// عرض الأصناف بالجدول
function renderItems() {
    let table = document.getElementById("itemsTable");
    table.innerHTML = "";

    let totalFinal = 0;

    invoiceItems.forEach((item, index) => {
        totalFinal += item.total;

        table.innerHTML += `
            <tr>
                <td>${item.name}</td>
                <td>${item.qty}</td>
                <td>${item.price}</td>
                <td>${item.total}</td>
                <td><button onclick="deleteItem(${index})">❌</button></td>
            </tr>
        `;
    });

    document.getElementById("totalFinal").innerText = totalFinal;
}

// حذف عنصر
window.deleteItem = function (index) {
    invoiceItems.splice(index, 1);
    renderItems();
};

// حفظ الفاتورة
window.saveInvoice = async function () {
    let customerId = document.getElementById("customerSelect").value;

    if (!customerId) return alert("اختر العميل أولاً");

    if (invoiceItems.length === 0)
        return alert("لا توجد أصناف في الفاتورة");

    const { data, error } = await supabase
        .from("sales_invoices")
        .insert([{
            customer_id: customerId,
            items: invoiceItems,
            total: document.getElementById("totalFinal").innerText
        }])
        .select();

    if (error) {
        console.log(error);
        return alert("فشل الحفظ");
    }

    const invoiceId = data[0].id;

    window.location.href = `sales_invoice.html?id=${invoiceId}`;
};

// تحميل البيانات عند فتح الصفحة
loadCustomers();
loadProducts();
