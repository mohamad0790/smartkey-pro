import { supabase } from "../supabase.js";

let products = [];
let customers = [];
let invoiceItems = [];

// تحميل العملاء
async function loadCustomers() {
    const { data } = await supabase.from("customers").select("*");
    let select = document.getElementById("customerSelect");

    select.innerHTML = "<option value=''>اختر العميل</option>";

    data.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });

    customers = data;
}

// تحميل المنتجات + السعر
async function loadProducts() {
    const { data } = await supabase.from("products").select("*");
    let select = document.getElementById("productSelect");

    select.innerHTML = "<option value=''>اختر المنتج</option>";

    data.forEach(p => {
        select.innerHTML += `
            <option value="${p.id}" data-price="${p.sell}">
                ${p.name}
            </option>`;
    });

    products = data;
}

// إضافة صنف للفاتورة
window.addItem = function () {
    let productSelect = document.getElementById("productSelect");
    let productId = productSelect.value;

    let qty = Number(document.getElementById("qty").value);
    let discount = Number(document.getElementById("discount").value) || 0;

    if (!productId || qty <= 0) {
        alert("⚠️ اختر منتج وكمية صحيحة");
        return;
    }

    let productName = productSelect.options[productSelect.selectedIndex].textContent;
    let price = Number(productSelect.options[productSelect.selectedIndex].dataset.price);

    let total = (price * qty) - discount;

    invoiceItems.push({
        product_id: productId,
        name: productName,
        qty,
        price,
        discount,
        total
    });

    renderTable();
};

// عرض الجدول
function renderTable() {
    let table = document.getElementById("itemsTable");
    table.innerHTML = "";

    let totalFinal = 0;

    invoiceItems.forEach((item, index) => {
        totalFinal += item.total;

        table.innerHTML += `
            <tr>
                <td>${item.name}</td>
                <td>${item.qty}</td>
                <td>${item.price}</td>
                <td>${item.total}</td>
                <td><button onclick="removeItem(${index})">❌</button></td>
            </tr>
        `;
    });

    document.getElementById("totalFinal").textContent = totalFinal;
}

// حذف صنف
window.removeItem = function (index) {
    invoiceItems.splice(index, 1);
    renderTable();
};

// حفظ الفاتورة
window.saveInvoice = async function () {
    let customerId = document.getElementById("customerSelect").value;

    if (!customerId) return alert("⚠️ اختر العميل");
    if (invoiceItems.length === 0) return alert("⚠️ لا توجد أصناف");

    // أولاً: إدخال الفاتورة
    const { data, error } = await supabase
        .from("sales_invoices")
        .insert([{ customer_id: customerId }])
        .select();

    if (error) {
        console.log(error);
        return alert("❌ فشل حفظ الفاتورة");
    }

    const invoiceId = data[0].id;

    // ثانياً: إدخال الأصناف في جدول sales
    for (const item of invoiceItems) {
        await supabase.from("sales").insert([{
            invoice_id: invoiceId,
            product_id: item.product_id,
            qty: item.qty,
            price: item.price,
            discount: item.discount,
            total: item.total
        }]);
    }

    alert("✅ تم إنشاء الفاتورة بنجاح");
    window.location.href = `sales_invoice.html?id=${invoiceId}`;
};

// تشغيل التحميل
loadCustomers();
loadProducts();
